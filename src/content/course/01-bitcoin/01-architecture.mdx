---
title: "Архитектура Bitcoin"
description: "Обзор архитектуры Bitcoin: peer-to-peer сеть, распределённый консенсус, неизменяемый ledger"
difficulty: "intermediate"
timeToComplete: 15
---

import { BlockStructureDiagram } from '../../../components/diagrams/BitcoinDiagrams';

# Архитектура Bitcoin

Bitcoin — первая decentralized cryptocurrency, запущенная в 2009 году Сатоши Накамото. Для data engineer важно понимать не столько криптографию, сколько **архитектурные решения**, которые легли в основу всех последующих блокчейнов. Bitcoin решил фундаментальную проблему распределённых систем: как достичь консенсуса между участниками, которые не доверяют друг другу?

До Bitcoin существовали цифровые валюты (DigiCash, e-gold), но все они требовали центрального оператора. Bitcoin стал первой системой, которая работает без доверенной третьей стороны — это возможно благодаря комбинации криптографии, теории игр и экономических стимулов.

## Проблема Double-Spending

<Callout type="note">
Bitcoin решает проблему **double-spending** в распределённой системе без центрального арбитра.
</Callout>

Представь цифровую валюту как файл: ты можешь скопировать файл и отправить его двум разным людям. В традиционных системах банк проверяет, что ты тратишь деньги только один раз. Но что если нет банка?

Bitcoin решает эту проблему через **публичный ledger** (блокчейн): каждая транзакция видна всем, и сеть коллективно соглашается, какие транзакции валидны. Если Алиса пытается потратить один и тот же биткоин дважды, сеть примет только первую транзакцию, которая попала в блок.

## Peer-to-Peer Network

Bitcoin работает на peer-to-peer сети — нет центрального сервера, который можно отключить. Каждый узел (node) хранит копию блокчейна и проверяет транзакции независимо. Даже если 90% узлов выйдут из строя, сеть продолжит работать.

Сеть использует **gossip protocol** для распространения информации: когда узел получает новую транзакцию или блок, он передаёт их всем своим соседям, те — своим, и так далее. За несколько секунд информация достигает всей сети.

### Типы узлов

| Тип | Хранилище | Функции | Примеры |
|-----|-----------|---------|---------|
| **Full nodes** | ~500GB (полная цепь) | Валидация всех правил, независимая проверка | Bitcoin Core |
| **Light nodes (SPV)** | ~100MB (заголовки) | Проверка через Merkle proofs, доверие к full nodes | Mobile wallets |
| **Mining nodes** | ~500GB + hardware | Full node + участие в PoW | Mining pools |
| **Archive nodes** | ~1TB+ | Full node + исторические данные, индексы | Block explorers |

Full node — это gold standard безопасности: он не доверяет никому и проверяет каждое правило протокола. "Don't trust, verify" — главный принцип Bitcoin.

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Full Node  │────▶│  Full Node  │────▶│ Mining Node │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  SPV Node   │     │  Full Node  │     │  Full Node  │
└─────────────┘     └─────────────┘     └─────────────┘
```

## Blockchain Structure

Блокчейн — это связный список блоков, где каждый блок содержит хеш предыдущего. Эта структура делает изменение истории практически невозможным: чтобы изменить транзакцию в старом блоке, нужно пересчитать все последующие блоки, что требует огромных вычислительных ресурсов.

Каждый блок состоит из **заголовка** (80 байт) и **списка транзакций**. Заголовок содержит всю метаинформацию, необходимую для связывания блоков и Proof of Work:

| Поле | Размер | Описание |
|------|--------|----------|
| Version | 4 bytes | Версия протокола (для soft forks) |
| Previous Block Hash | 32 bytes | SHA-256 хеш предыдущего блока — связь цепи |
| Merkle Root | 32 bytes | Корень дерева транзакций — компактное представление всех tx |
| Timestamp | 4 bytes | Unix timestamp (допускается погрешность ~2 часа) |
| Difficulty Target | 4 bytes | Текущая сложность в compact формате |
| Nonce | 4 bytes | Счётчик для Proof of Work |

<BlockStructureDiagram client:load />

**Почему 80 байт?** Фиксированный размер заголовка позволяет light nodes хранить только заголовки: 80 байт × 850,000 блоков ≈ 68 MB. Они могут проверить, что транзакция включена в блок, используя Merkle proof, не скачивая весь блок.

## Consensus Mechanism

Консенсус — это механизм, который позволяет всем узлам сети согласиться на одну версию истории. Bitcoin использует **Proof of Work (PoW)** — майнеры соревнуются за право добавить следующий блок, расходуя электричество на вычисления.

### Как работает PoW

1. **Сбор транзакций**: Майнер собирает pending транзакции из mempool
2. **Формирование блока**: Создаёт block header с Merkle root транзакций
3. **Поиск nonce**: Перебирает nonce пока `SHA256(SHA256(header)) < target`
4. **Broadcast**: Первый нашедший валидный блок получает reward + fees

<Callout type="warning">
Block time ~10 минут — это trade-off между безопасностью и latency. Меньше время = больше orphan blocks = меньше безопасность.
</Callout>

**Почему именно 10 минут?** Это компромисс. При меньшем интервале блоки не успевают распространиться по сети до появления следующего — появляются "orphan blocks" (две конкурирующие цепи). При большем интервале транзакции подтверждаются слишком медленно. 10 минут — баланс, выбранный Сатоши.

### Nakamoto Consensus

Bitcoin впервые решил проблему Byzantine Generals — как достичь консенсуса, когда часть участников может врать. Решение элегантно: **longest chain wins**. Если есть две конкурирующие цепи, честные узлы следуют за самой длинной (с наибольшим накопленным PoW). Атакующему нужно контролировать >50% hashrate, чтобы обогнать честную цепь.

## Данные для анализа

Для data engineer Bitcoin предоставляет богатый набор данных. Каждая транзакция — часть публичного графа, где можно отслеживать движение средств. Это делает Bitcoin идеальным для:

- **Транзакционного анализа** — граф движения средств (UTXO model), кластеризация адресов
- **Анализа блоков** — временные метки, сложность, размер, fee market dynamics
- **Mempool анализа** — pending транзакции, fee estimation, RBF (replace-by-fee)
- **Network metrics** — количество нод, географическое распределение, hashrate

```sql
-- Базовый анализ Bitcoin данных
SELECT
    DATE(block_timestamp) as date,
    COUNT(*) as tx_count,
    SUM(output_value) / 1e8 as btc_volume,
    AVG(fee) / 1e8 as avg_fee_btc,
    AVG(size) as avg_tx_size_bytes
FROM bitcoin.transactions
WHERE block_timestamp > '2024-01-01'
GROUP BY DATE(block_timestamp)
ORDER BY date DESC;
```

## Резюме

- **P2P сеть**: Нет центрального сервера, тысячи независимых узлов по всему миру
- **Блокчейн**: Связный список блоков, где каждый ссылается на предыдущий через хеш
- **PoW консенсус**: Майнеры соревнуются за право добавить блок, расходуя электричество
- **Блок**: ~1MB, ~2000-3000 транзакций, каждые ~10 минут
- **Full node**: ~500GB хранилища, полная независимая проверка всех правил
- **Данные**: Публичны и доступны для анализа — граф транзакций, метрики сети

---
title: "Деривативы и перпетуалы"
description: "Бессрочные фьючерсы: funding rate, leverage, маржа, ликвидация и DeFi протоколы деривативов"
order: 11
difficulty: "advanced"
estimatedTime: 25
topics: ["Derivatives", "Perpetuals", "Funding Rate", "Leverage", "dYdX", "GMX"]
prerequisites: ["10-stablecoins"]
---

import { FundingRateDiagram, LeverageLiquidationDiagram } from '../../../components/diagrams/module5/DerivativesDiagrams';

# Деривативы и перпетуалы

## Зачем это блокчейну?

Спот-рынок позволяет покупать и продавать активы напрямую. **Деривативы** -- это контракты _на_ активы: вы торгуете не самим ETH, а контрактом, привязанным к цене ETH. **Perpetual futures** (бессрочные фьючерсы) -- доминирующий инструмент криптотрейдинга.

Объем торгов перпетуалами в **3-5 раз превышает** спот-рынок. На пике 2024 года дневной объем perpetual контрактов превышал $100 миллиардов. Понимание их механики -- ключ к пониманию структуры крипторынка.

> В этом уроке мы разберем perpetuals концептуально. Это самый сложный и рискованный инструмент в DeFi -- лабораторные работы для него выходят за рамки вводного курса.

## Что такое перпетуалы?

### Традиционные фьючерсы vs Perpetuals

**Фьючерс** -- контракт на покупку/продажу актива по фиксированной цене в определенную дату:
- BTC March Futures: купить BTC за $50,000 31 марта
- При экспирации происходит расчет (settlement)
- Нужно постоянно "роллить" позицию на следующий контракт

**Perpetual** (перпетуал) -- бессрочный фьючерс **без даты экспирации**:
- Позиция может удерживаться неограниченно
- Нет rollover между контрактами
- Специальный механизм (**funding rate**) привязывает цену к спотовой

### Почему перпетуалы доминируют?

1. **Простота:** один контракт вместо множества с разными датами
2. **Ликвидность:** вся ликвидность сосредоточена в одном инструменте
3. **Leverage:** доступно кредитное плечо до 50-100x
4. **24/7 торговля:** в отличие от традиционных бирж, крипто-перпы работают круглосуточно

## Funding Rate: привязка к спот-цене

Ключевая проблема: если у перпетуала нет даты экспирации, что мешает его цене полностью отклониться от спотовой? Ответ -- **funding rate**.

<FundingRateDiagram client:load />

### Интуитивное объяснение

Funding rate -- это **периодический платеж** между лонгами и шортами (обычно каждые 8 часов):

| Ситуация | Платеж | Эффект |
|----------|--------|--------|
| Perp > Spot (premium) | Лонги платят шортам | Стимул к шортам: цена перпа снижается |
| Perp < Spot (discount) | Шорты платят лонгам | Стимул к лонгам: цена перпа растет |
| Perp = Spot | Никто не платит | Равновесие |

### Алгоритмический уровень

Расчет funding rate:

```
FR = (Perp_Price - Spot_Price) / Spot_Price * (interval / 8h)
```

**Пример:**
- Perp ETH = $2,050, Spot ETH = $2,000
- FR = (2050 - 2000) / 2000 * 1 = 0.025 = **2.5%** за 8 часов
- Позиция $10,000 long: платеж = $10,000 * 0.025 = **$250**

### Математический уровень

На практике биржи используют более сложную формулу с двумя компонентами:

```
FR = Average Premium Index + clamp(Interest Rate - Premium Index, -0.05%, 0.05%)
```

Где **Premium Index** = (TWAP_perp - TWAP_spot) / TWAP_spot, а **Interest Rate** обычно фиксирован (0.01% на Binance/dYdX).

Типичные значения:
- **Нейтральный рынок:** ~0.01% per 8h (~11% annualized)
- **Бычий рынок:** 0.05-0.3% per 8h (лонги сильно переплачивают)
- **Медвежий рынок:** -0.01 to -0.1% (шорты платят)

## Leverage и маржа

Перпетуалы позволяют торговать с **кредитным плечом (leverage)** -- контролировать позицию, превышающую ваш депозит.

<LeverageLiquidationDiagram client:visible />

### Как работает leverage

| Leverage | Margin | Position | 10% рост | 10% падение |
|----------|--------|----------|----------|-------------|
| 1x | $1,000 | $1,000 | +$100 (+10%) | -$100 (-10%) |
| 5x | $1,000 | $5,000 | +$500 (+50%) | -$500 (-50%) |
| 10x | $1,000 | $10,000 | +$1,000 (+100%) | -$1,000 (-100%) |
| 20x | $1,000 | $20,000 | +$2,000 (+200%) | -$1,000 (liquidated at -5%) |

### Типы маржи

**Initial Margin** -- минимальный депозит для открытия позиции:
```
Initial Margin = Position Size / Leverage
```
Для 10x: $10,000 / 10 = $1,000

**Maintenance Margin** -- минимальный депозит для удержания позиции (обычно 2-5% от позиции):
```
Maintenance Margin = Position Size * Maintenance Rate
```
Для 5%: $10,000 * 0.05 = $500

### Ликвидация

Когда ваша маржа падает ниже maintenance margin, позиция **ликвидируется** принудительно:

```
Liquidation Price (long) = Entry Price * (1 - Initial Margin Rate + Maintenance Rate)
Liquidation Price (short) = Entry Price * (1 + Initial Margin Rate - Maintenance Rate)
```

**Пример (long, 10x):**
- Entry = $2,000, Initial Margin Rate = 10% (1/10x), Maintenance = 5%
- Liquidation = $2,000 * (1 - 0.10 + 0.05) = $2,000 * 0.95 = **$1,900**
- Падение ETH на 5% = ликвидация

> **Внимание:** ликвидация обычно включает штраф (liquidation fee) в 0.5-1%. Реальная потеря превышает 100% маржи!

## DeFi Perpetual Protocols

Несколько протоколов перенесли механику перпетуалов на блокчейн. Каждый использует уникальный подход:

### dYdX

- **Модель:** Orderbook-based (как CEX, но on-chain settlement)
- **Технология:** StarkEx (ZK-rollup на Ethereum) для скорости и низких комиссий
- **Leverage:** до 20x
- **Особенность:** Migrated to own Cosmos app-chain (dYdX Chain) для полной децентрализации orderbook

### GMX

- **Модель:** Oracle-based pricing (нет AMM, нет orderbook)
- **Ликвидность:** GLP -- мульти-токенный пул (ETH, BTC, USDC, ...). LP предоставляют ликвидность для всех трейдеров
- **Цена:** определяется Chainlink + Pyth оракулами
- **Особенность:** "Zero slippage" на бумаге (цена = oracle price). Но LP несут risk от прибыльных трейдеров
- **Сеть:** Arbitrum, Avalanche

### Hyperliquid

- **Модель:** Purpose-built L1 blockchain для perpetual trading
- **Технология:** Собственный консенсус, оптимизированный для matching engine
- **Latency:** ~200ms (vs секунды для Ethereum)
- **Особенность:** Централизованная скорость с on-chain settlement

### Сравнение подходов

| Свойство | dYdX | GMX | Hyperliquid |
|----------|------|-----|-------------|
| Pricing | Orderbook | Oracle | Orderbook |
| Execution | ZK-rollup | L2 (Arbitrum) | Own L1 |
| Slippage | Market-based | Near zero | Market-based |
| LP Model | Market makers | GLP pool | Market makers |
| Decentralization | Medium | High | Low |

> Это **концептуальный обзор**. Каждый протокол имеет сложную механику и уникальные риски. Для продвинутого изучения рекомендуем документацию каждого проекта.

## Риски деривативов

### Leverage Risk

Leverage -- самый опасный инструмент в DeFi. Статистика:
- **70-80% розничных трейдеров** теряют деньги на перпетуалах
- Средний срок жизни высоколевериджной позиции: **часы, не дни**
- Каскадные ликвидации могут вызвать **flash crash** (мгновенное падение на 20-30%)

### Funding Rate Risk

Funding rate может быть значительным:
- В бычьем рынке 2024: 0.1% per 8h = **36.5% annualized** (лонги платят)
- Удержание позиции месяцами с высоким funding = существенные потери даже при правильном направлении

### Каскадные ликвидации

Падение цены -> ликвидации -> принудительные продажи -> дальнейшее падение -> больше ликвидаций:
- **Пример:** 12 марта 2020 ("Black Thursday") -- $1B ликвидаций за 24 часа, ETH -50%
- Аналогичный механизм каскадным ликвидациям в lending (DEFI-07)

### Smart Contract Risk

- DeFi perpetual protocols содержат сложнейшие смарт-контракты
- Баги в расчете маржи, ликвидации или funding rate = потенциальная потеря всех средств пула
- Oracle manipulation может вызвать неправильные ликвидации

## Связь с оракулами

Перпетуал-протоколы **критически зависят** от оракулов (DEFI-08, DEFI-09):

1. **Funding Rate:** требуется точная спот-цена для расчета premium
2. **Ликвидации:** oracle price определяет, когда позиция ликвидируется
3. **GMX execution:** все сделки исполняются по oracle price (Chainlink + Pyth)

```
Oracle feeds -> Funding Rate calculation -> Settlement
                                         -> Liquidation triggers
                                         -> Mark Price (for P&L)
```

**Oracle manipulation** -- один из главных векторов атак на perpetual protocols:
- Манипуляция ценой на одном DEX может вызвать каскадные ликвидации
- Защита: multi-source oracles, TWAP (Time-Weighted Average Price), circuit breakers

## Ключевые выводы

1. **Perpetuals** -- бессрочные фьючерсы без даты экспирации, доминирующий инструмент криптотрейдинга
2. **Funding Rate** -- периодический платеж (каждые 8h), привязывающий perp price к spot
3. **Leverage** усиливает и прибыль, и убытки. 10x leverage + 10% move = 100% loss
4. **Ликвидация** происходит при падении маржи ниже maintenance margin
5. **DeFi perp protocols** (dYdX, GMX, Hyperliquid) используют разные модели: orderbook, oracle-based, dedicated L1
6. **Риски:** leverage, funding rate accumulation, каскадные ликвидации, smart contract bugs, oracle manipulation

> **Следующий урок:** Токеномика -- как дизайн токенов влияет на поведение участников DeFi. Supply mechanics, vesting, governance и модель veCRV.

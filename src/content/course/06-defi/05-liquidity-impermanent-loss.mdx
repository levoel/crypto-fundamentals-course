---
title: "Ликвидность и Impermanent Loss"
description: "Формула IL = 2sqrt(r)/(1+r) - 1, вывод, калькулятор, комиссии vs потери и управление позицией"
order: 5
difficulty: "advanced"
estimatedTime: 35
topics: ["Impermanent Loss", "LP", "Liquidity", "Fee Revenue", "Position Management"]
prerequisites: ["04-uniswap-v3-concentrated"]
---

import { ILCalculatorDiagram, ILFormulaDerivationDiagram, FeeVsILBreakevenDiagram, PositionManagementFlowDiagram } from '../../../components/diagrams/module5/LiquidityImpermanentLossDiagrams';

# Ликвидность и Impermanent Loss

## Зачем это блокчейну?

Вы предоставили ликвидность в пул ETH/USDC. ETH вырос на 100% (2x). Вы заработали? **Не обязательно.** Impermanent Loss означает, что ваша позиция в пуле стоит **МЕНЬШЕ**, чем если бы вы просто держали токены. Это не потеря депозитов -- это **упущенная выгода**.

Понимание IL -- критически важно для любого, кто предоставляет ликвидность. Без этого знания LP рискует потерять больше на IL, чем заработать на комиссиях.

## Что такое Impermanent Loss

### Интуитивное объяснение

**Аналогия:** Представьте, что вы обменяли половину своих сбережений на евро, а половину оставили в долларах. Если курс евро вырос, ваша "корзина" (50/50) стоит МЕНЬШЕ, чем если бы вы оставили все в евро (100% в выросшем активе). AMM автоматически продает растущий актив и покупает падающий -- это и есть источник IL.

### Ключевые свойства IL

1. **Это НЕ потеря депозита.** IL -- это разница между стоимостью вашей позиции в пуле и стоимостью, если бы вы просто держали (HODL) те же токены
2. **"Impermanent" -- потому что обратим.** Если цена вернется к начальной, IL = 0
3. **Становится "permanent"** только при выводе ликвидности при изменившейся цене
4. **Всегда отрицательный** (или нулевой). LP value ≤ HODL value

### IL -- это стоимость ребалансировки

AMM автоматически ребалансирует вашу позицию:
- Цена A растет -> AMM продает A, покупает B (вы теряете exposure к растущему активу)
- Цена A падает -> AMM покупает A, продает B (вы покупаете падающий актив)

Арбитражеры извлекают стоимость ребалансировки -- это и есть IL.

## Калькулятор IL

<ILCalculatorDiagram client:load />

### Ключевые значения

| Изменение цены | Price ratio (r) | IL |
|----------------|-----------------|-----|
| +25% | 1.25 | -0.6% |
| +50% | 1.50 | -2.0% |
| 2x (удвоение) | 2.00 | -5.7% |
| 3x | 3.00 | -13.4% |
| 5x | 5.00 | -25.5% |
| -50% | 0.50 | -5.7% |
| -80% | 0.20 | -25.5% |

> **Симметрия:** IL при 2x вверх = IL при 2x вниз (0.5x) = **-5.7%**. Формула зависит только от |изменения|, не от направления.

## Вывод формулы IL

<ILFormulaDerivationDiagram client:load />

### Формальный вывод

**Начальные условия:**

LP вносит равную стоимость двух токенов:
- x единиц Token A по цене P -> стоимость = x * P
- y единиц Token B -> стоимость = y
- Равный депозит: x * P = y, значит y = x * P

**Шаг 1: Цена меняется**

Новая цена: $P_{new} = r \cdot P$, где $r = P_{new}/P$.

**Шаг 2: AMM ребалансирует**

Из инварианта $x \cdot y = k$ и нового соотношения цен $\frac{y_{new}}{x_{new}} = r \cdot P$:

$$
x_{new} = \frac{x}{\sqrt{r}}, \quad y_{new} = y \cdot \sqrt{r}
$$

**Шаг 3: Сравнение стоимостей**

Стоимость LP позиции:

$$
V_{LP} = x_{new} \cdot P_{new} + y_{new} = \frac{x \cdot r \cdot P}{\sqrt{r}} + y \cdot \sqrt{r} = 2 \cdot x \cdot P \cdot \sqrt{r}
$$

Стоимость HODL (просто держать):

$$
V_{HODL} = x \cdot P_{new} + y = x \cdot r \cdot P + x \cdot P = x \cdot P \cdot (1 + r)
$$

**Шаг 4: Формула IL**

$$
IL = \frac{V_{LP}}{V_{HODL}} - 1 = \frac{2\sqrt{r}}{1 + r} - 1
$$

**Свойства:**

$$
IL(r) \leq 0 \text{ для всех } r > 0
$$

$$
IL(1) = 0 \text{ (цена не изменилась)}
$$

$$
IL(r) = IL(1/r) \text{ (симметрия)}
$$

## Комиссии vs IL: точка безубыточности

<FeeVsILBreakevenDiagram client:load />

### Общая доходность LP

$$
\text{Total LP Return} = \text{Fee Revenue} + IL
$$

Поскольку IL всегда отрицательный:

$$
\text{LP прибылен} \Leftrightarrow \text{Fee APR} > |IL|
$$

### Оценка прибыльности

**Fee APR** зависит от:
- Объема торгов (больше свопов = больше комиссий)
- TVL пула (больше ликвидности = меньше доля каждого LP)
- Fee tier (0.01%, 0.05%, 0.3%, 1%)

```
Fee APR = (Daily Volume * Fee Rate * 365) / TVL
```

**Пример:** Пул ETH/USDC, daily volume = $100M, TVL = $500M, fee = 0.3%:

```
Fee APR = (100M * 0.003 * 365) / 500M = 109.5M / 500M = 21.9%
```

При такой доходности LP может выдержать значительные ценовые колебания и остаться прибыльным.

### Идеальные пулы для LP

| Характеристика | Хороший пул | Плохой пул |
|----------------|-------------|------------|
| Волатильность | Низкая (стейблкоины) | Высокая (мем-токены) |
| Объем торгов | Высокий | Низкий |
| Fee tier | Соответствует волатильности | Не соответствует |
| Пример | USDC/DAI (0.01%) | SHIB/ETH (1%) |
| IL ожидание | ~0% | 10-50%+ |
| Fee APR | 2-10% | Непредсказуемо |

## Управление LP позицией

<PositionManagementFlowDiagram client:load />

### V2: Set & Forget

В V2 ликвидность покрывает весь диапазон [0, infinity):
- Позиция **всегда** зарабатывает комиссии
- Нет необходимости в ребалансировке
- IL относительно умеренный
- Подходит для пассивных LP

### V3: Активное управление

V3 требует выбора диапазона и мониторинга:

**Узкий диапазон (например, [1900, 2100]):**
- Высокая capital efficiency (10-100x vs V2)
- Большие комиссии при нахождении в диапазоне
- Часто выходит из диапазона -> нет комиссий
- Требует частой ребалансировки (gas!)

**Широкий диапазон (например, [1000, 4000]):**
- Умеренная efficiency (2-5x vs V2)
- Меньше комиссий на единицу капитала
- Редко выходит из диапазона
- Меньше ребалансировок

### Ребалансировка

Когда позиция выходит из диапазона:

1. **Оценить:** Вернется ли цена? Если да -- подождать
2. **Если нет -- ребалансировать:**
   - Вывести ликвидность (collect + decreaseLiquidity)
   - Обменять 100%-один-токен обратно на 50/50
   - Открыть новую позицию с обновленным диапазоном
3. **Учитывать gas:** Каждая ребалансировка стоит ~$5-50 в gas

### Автоматические менеджеры

Для V3 существуют протоколы автоматического управления позициями:
- **Arrakis Finance** -- автоматическая ребалансировка V3 позиций
- **Gamma** -- managed liquidity с различными стратегиями
- **Bunni** -- LP management с hooks (V4)

Они автоматизируют ребалансировку, но берут дополнительную комиссию (0.5-2%).

## V3 и Impermanent Loss

### IL в V3 усилен

Concentrated liquidity **усиливает** IL внутри диапазона. Узкий диапазон = больше комиссий, но и **больше IL** при том же ценовом движении.

Интуитивно: V3 LP ведет себя как V2 LP с гораздо бОльшим капиталом в узком диапазоне. Больший виртуальный капитал = больше виртуального IL.

### Формула V3 IL

Для позиции в диапазоне [p_a, p_b]:

$$
IL_{V3} = IL_{V2} \cdot \text{amplification factor}
$$

Amplification factor зависит от ширины диапазона и приближается к infinity для очень узких диапазонов. Это еще один трейдофф: capital efficiency vs IL risk.

## Математический уровень

### Производная IL

$$
\frac{d(IL)}{dr} = \frac{1/\sqrt{r} - 2\sqrt{r}}{(1+r)^2} = \frac{1 - 2r}{\sqrt{r} \cdot (1+r)^2}
$$

**Точки перегиба:**
- $\frac{d(IL)}{dr} = 0$ при $r = 0.5$ и $r = 2.0$
- Максимальная скорость изменения IL: при $r = 0.5$ и $r = 2.0$

### Разложение в ряд Тейлора

При малых отклонениях ($r = 1 + \epsilon$, $|\epsilon| \ll 1$):

$$
IL \approx -\frac{\epsilon^2}{8}
$$

Это означает, что для **малых** ценовых изменений IL пропорционален **квадрату** изменения. 10% изменение цены дает ~1.25% IL. 20% изменение -- ~5% IL (квадратичный рост).

### Fee APR для безубыточности

При ожидаемой годовой волатильности $\sigma$ (стандартное отклонение доходности):

$$
\text{Required Fee APR} \approx \frac{\sigma^2}{8}
$$

**Пример:** ETH annual volatility ~80% ($\sigma = 0.8$):

```
Required APR = 0.8^2 / 8 = 0.64 / 8 = 8%
```

Если fee APR > 8%, LP скорее всего будет прибыльным.

## Практический совет

Перед предоставлением ликвидности оцените:

1. **Ожидаемый fee APR** = (дневной объем * fee rate * 365) / TVL
2. **Ожидаемая волатильность** = историческая 30-дневная volatility
3. **Break-even:** fee APR > $\sigma^2/8$?
4. **Если да** -- LP скорее всего прибылен
5. **Если нет** -- HODL может быть лучшей стратегией

> **Помните:** Fee APR и волатильность -- это ОЦЕНКИ. Реальные значения могут отличаться. Начинайте с малых сумм и широких диапазонов.

## Что дальше

В следующем уроке (**DEFI-06**) мы перейдем к **протоколам кредитования**: Aave, Compound и Maker. Это вторая фундаментальная категория DeFi после DEX: как работает overcollateralized lending, liquidation, и stablecoin механика.

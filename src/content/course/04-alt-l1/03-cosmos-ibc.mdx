---
title: "Cosmos & IBC"
description: "Cosmos SDK, Tendermint consensus, Inter-Blockchain Communication protocol"
difficulty: "intermediate"
timeToComplete: 20
---

# Cosmos & IBC

Cosmos представляет **третий путь** в blockchain design. Ethereum: один chain, много apps. Solana: один быстрый chain. Cosmos: **много специализированных chains**, связанных протоколом.

Философия Cosmos: каждое приложение заслуживает своего blockchain с полным **суверенитетом** над правилами, fee structure, governance. dYdX не хочет конкурировать за block space с NFT проектами. Osmosis хочет свою token economics. Celestia хочет оптимизировать только DA.

IBC (Inter-Blockchain Communication) — это "TCP/IP для блокчейнов", протокол, который позволяет этим независимым chains обмениваться токенами и сообщениями trustlessly.

Для data engineer Cosmos интересен тем, что:
- **Много chains** — нужно индексировать десятки независимых networks
- **IBC transfers** — cross-chain data flow создаёт complex graph
- **Каждый chain уникален** — разные APIs, разные modules
- **Tendermint finality** — instant finality упрощает indexing (нет reorgs)

## Cosmos vs Monolithic Chains

Сравним два подхода. На Ethereum Uniswap, Aave, и тысячи других protocols живут на одном chain. Они **конкурируют** за block space, **делят** security, и **связаны** общим state. На Cosmos каждый major protocol — **отдельный blockchain** со своими validators, своим token, своей governance.

<Callout type="note">
Cosmos approach: каждое приложение — отдельный blockchain с суверенитетом над своими правилами. IBC соединяет их.
</Callout>

```
Monolithic (Ethereum):
┌─────────────────────────────────────────────────────────────┐
│                      Ethereum                                │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ Uniswap │ │  Aave   │ │ OpenSea │ │ Compound│           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
│             All share same execution layer                  │
└─────────────────────────────────────────────────────────────┘

Cosmos (App-Chains):
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Osmosis   │  │    dYdX     │  │   Stride    │
│  (DEX chain)│  │ (perps chain)│ │(staking chain)│
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                   IBC Protocol
                        │
              ┌─────────┴─────────┐
              │    Cosmos Hub     │
              │   (ATOM staking)  │
              └───────────────────┘
```

## Cosmos SDK

Cosmos SDK — framework для building application-specific blockchains. Вместо того чтобы писать smart contracts, ты пишешь **modules** — Rust или Go код, который напрямую интегрируется в blockchain runtime. Это даёт полный контроль над state machine.

Think of it as: Ethereum = runtime platform (EVM) + apps (contracts). Cosmos SDK = framework для создания custom runtimes.

### Module Architecture

Cosmos SDK app состоит из modules, каждый отвечает за свой domain. Bank module — transfers. Staking — validators. Gov — voting. Ты можешь использовать ready-made modules и добавить custom logic.

```
┌─────────────────────────────────────────────────────────────┐
│                   Cosmos SDK App                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │   Auth   │ │   Bank   │ │  Staking │ │   Gov    │       │
│  │ (accounts)│ │(transfers)│ │(validators)│ │(voting) │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│                                                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │   IBC    │ │  Custom  │ │  Custom  │ │   ...    │       │
│  │ (bridge) │ │ Module 1 │ │ Module 2 │ │          │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│                                                             │
│  ────────────────────────────────────────────────────────  │
│                      BaseApp (ABCI)                         │
│  ────────────────────────────────────────────────────────  │
│                                                             │
│                    Tendermint Core                          │
│              (Consensus + Networking)                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### ABCI (Application Blockchain Interface)

```
Tendermint (Consensus)        Application (Business Logic)
       │                              │
       │ ◄─── BeginBlock ───────────► │
       │ ◄─── DeliverTx  ───────────► │ (for each tx)
       │ ◄─── EndBlock   ───────────► │
       │ ◄─── Commit     ───────────► │
       │                              │

ABCI позволяет писать app logic на любом языке
(Go, Rust via CosmWasm, etc.)
```

## Tendermint Consensus

Tendermint — BFT (Byzantine Fault Tolerant) consensus engine, который используется почти всеми Cosmos chains. Главное свойство: **instant finality**. Когда блок committed — он финален. Нет probabilistic confirmation как в Ethereum, нет reorgs.

Trade-off: Tendermint требует 2/3+ валидаторов online. Если больше 1/3 offline — сеть **останавливается** (но не делает invalid commits). Это "safety over liveness" design.

### BFT Rounds

Tendermint работает в rounds. Каждый round имеет proposer (выбирается детерминистично). Если proposer не предложил блок вовремя — timeout и новый round с новым proposer.

```
┌─────────────────────────────────────────────────────────────┐
│                  Tendermint Round                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. PROPOSE                                                 │
│     Proposer broadcasts block                               │
│                                                             │
│  2. PREVOTE                                                 │
│     Validators prevote for block (or nil)                  │
│     Wait for 2/3+ prevotes                                  │
│                                                             │
│  3. PRECOMMIT                                               │
│     Validators precommit if 2/3+ prevoted same              │
│     Wait for 2/3+ precommits                                │
│                                                             │
│  4. COMMIT                                                  │
│     If 2/3+ precommitted same block → finalize              │
│     Otherwise → next round                                  │
│                                                             │
│  Timeout between phases → ensures liveness                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

<Callout type="warning">
Tendermint sacrifices liveness for safety: если >1/3 validators offline, сеть останавливается (но не делает invalid commits).
</Callout>

### Finality

```
Instant finality: block committed = finalized

No probabilistic confirmation needed
No reorgs possible (safety guarantee)

Trade-off: requires 2/3+ online validators
           limited to ~400 validators практически
```

## IBC Protocol

IBC — **trustless** cross-chain communication protocol. Это не bridge с multisig (как большинство Ethereum bridges). IBC использует **light clients** — каждый chain хранит cryptographic proof состояния другого chain. Если counterparty chain лжёт — light client это обнаружит.

IBC — это TCP/IP layer для blockchains. Он не специфичен для tokens — можно передавать любые данные: governance votes, oracle data, arbitrary messages.

### Core Components

IBC architecture состоит из 4 layers: Light Clients (track consensus state), Connections (authenticated links), Channels (app-level paths), Packets (actual data).

```
┌─────────────────────────────────────────────────────────────┐
│                      IBC Protocol                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Light Clients:                                             │
│  - Each chain maintains light client of connected chains   │
│  - Tracks consensus state (validator set, heights)         │
│                                                             │
│  Connections:                                               │
│  - Established via handshake (INIT → TRY → ACK → CONFIRM)  │
│  - Authentication between chains                           │
│                                                             │
│  Channels:                                                  │
│  - Application-level communication path                    │
│  - Ordered or unordered delivery                           │
│                                                             │
│  Packets:                                                   │
│  - Actual data being transferred                           │
│  - Timeout mechanism for reliability                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### IBC Token Transfer

```
Chain A                    Relayer                    Chain B
   │                          │                          │
   │ Lock tokens              │                          │
   │ in escrow                │                          │
   │──────────────────────────┼──────────────────────────┤
   │                          │                          │
   │ SendPacket ─────────────►│                          │
   │                          │                          │
   │                          │ RecvPacket ─────────────►│
   │                          │                          │
   │                          │              Mint vouchers│
   │                          │                          │
   │                          │◄──────────── WriteAck ───│
   │                          │                          │
   │◄──────────── AckPacket ──│                          │
   │                          │                          │
   │ Confirm                  │                          │
   │ transfer                 │                          │
```

### Relayers

Relayers — off-chain software, который "носит" пакеты между chains. Важно: relayers не trusted! Они просто передают data и proofs. Если relayer лжёт — light client отклонит невалидный proof. Permissionless: любой может запустить relayer.

```
Relayers = off-chain processes that:
- Monitor IBC events on chains
- Construct and submit proofs
- Relay packets between chains

Permissionless: anyone can run a relayer
Incentivized: fees from packet processing

Major relayers:
- Hermes (Rust)
- Go Relayer
- many others
```

## Ecosystem

### Major App-Chains

| Chain | Purpose | Validators | IBC Connections |
|-------|---------|------------|-----------------|
| Cosmos Hub | Security, ATOM | ~180 | 50+ |
| Osmosis | DEX | ~150 | 60+ |
| dYdX | Perpetuals | ~60 | 10+ |
| Celestia | DA Layer | ~100 | 5+ |
| Injective | DeFi | ~50 | 20+ |

### Interchain Security (ICS)

Проблема app-chains: каждый chain должен bootstrap свой validator set и security. Для нового проекта это сложно — нужно привлечь капитал и validators. Interchain Security решает это: новые chains могут "арендовать" security у Cosmos Hub. ATOM stakers валидируют multiple chains и получают rewards от всех.

```
┌─────────────────────────────────────────────────────────────┐
│               Interchain Security (ICS)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Provider Chain (Cosmos Hub):                               │
│  - ATOM stakers validate multiple chains                    │
│  - Slashing applies across chains                           │
│                                                             │
│  Consumer Chains:                                           │
│  - Inherit security from provider                           │
│  - Share validators set                                     │
│  - Pay fees to provider chain                               │
│                                                             │
│  Examples: Neutron, Stride (as consumer chains)             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Data для анализа

```sql
-- IBC transfers
SELECT
    DATE(block_timestamp) as date,
    source_chain,
    destination_chain,
    COUNT(*) as transfer_count,
    SUM(amount) as total_amount,
    denom
FROM ibc.transfers
WHERE block_timestamp > CURRENT_DATE - INTERVAL '30 days'
GROUP BY date, source_chain, destination_chain, denom
ORDER BY date DESC, transfer_count DESC;

-- Active IBC channels
SELECT
    chain_a,
    chain_b,
    channel_state,
    COUNT(*) as packet_count
FROM ibc.channels
JOIN ibc.packets USING (channel_id)
WHERE packet_timestamp > CURRENT_DATE - INTERVAL '7 days'
GROUP BY chain_a, chain_b, channel_state
ORDER BY packet_count DESC;
```

## Резюме

- Cosmos: app-chains вместо monolithic chain
- Cosmos SDK: modular framework для building blockchains
- Tendermint: BFT consensus, instant finality, limited validators
- IBC: trustless cross-chain communication
- Light clients + Relayers + Channels + Packets
- Trade-off: sovereignty vs shared liquidity/composability

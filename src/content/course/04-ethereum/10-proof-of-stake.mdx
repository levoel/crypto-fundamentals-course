---
title: "Proof of Stake и Beacon Chain"
description: "Как Ethereum перешел с PoW на PoS -- консенсус Casper FFG + LMD GHOST, слоты, эпохи и финальность"
order: 10
difficulty: "intermediate"
estimatedTime: 30
topics: ["Proof of Stake", "Beacon Chain", "Casper FFG", "LMD GHOST", "The Merge", "Pectra"]
prerequisites: ["01-ethereum-architecture"]
---

import { PoWvsPoSDiagram, BeaconChainDiagram } from '../../../components/diagrams/module3/ProofOfStakeDiagrams';

# Proof of Stake и Beacon Chain

## Зачем Ethereum перешел на PoS?

В уроках BTC-06/07 мы подробно разобрали Proof of Work: майнеры перебирают миллиарды nonce в секунду, чтобы найти хеш ниже target. PoW работает и обеспечивает безопасность Bitcoin, но у него есть фундаментальная проблема -- **огромное потребление энергии**. Сеть Bitcoin потребляет ~150 TWh/год -- сравнимо с энергопотреблением Аргентины.

15 сентября 2022 года Ethereum совершил **The Merge** -- переход с Proof of Work на **Proof of Stake**. Вместо вычислительной работы безопасность обеспечивается экономическим залогом: валидаторы блокируют ETH и рискуют потерять их за нечестное поведение.

```
PoW (Bitcoin):  Безопасность = вычислительная работа (ASIC, электричество)
PoS (Ethereum): Безопасность = экономический залог (32+ ETH заблокированы)

Атака на PoW = купить 51% хешрейта = миллиарды $ на оборудование + электричество
Атака на PoS = купить 33%+ стейка = десятки миллиардов $ в ETH (и потерять их при slashing)
```

## Интуитивное объяснение: залог вместо работы

Представьте два способа обеспечить честность кассира в банке:

**PoW-подход:** Кассир должен каждый день решать сложные математические задачи. Если он мошенничает -- его уволят, и все потраченное время будет потеряно. Но каждый день он тратит энергию на задачи, даже если ведет себя честно.

**PoS-подход:** Кассир вносит крупный залог при приеме на работу. Если он мошенничает -- залог конфискуется. Если ведет себя честно -- получает зарплату и залог остается при нем. Никакой бессмысленной работы.

**Proof of Stake -- это залог вместо бессмысленной работы.** Наказание за мошенничество -- потеря собственных денег (slashing), а не просто потраченного электричества.

## PoW vs PoS: сравнение

<PoWvsPoSDiagram client:load />

Ключевое отличие: в PoW наказание за атаку -- **внешнее** (потраченное электричество), а в PoS -- **внутреннее** (конфискация залога протоколом). Это позволяет PoS наказывать атакующих намного эффективнее.

## The Merge: как это произошло

The Merge -- одно из самых сложных обновлений в истории блокчейнов. Ethereum переключил консенсус на работающей системе с сотнями миллиардов долларов без остановки:

1. **Декабрь 2020:** Запуск Beacon Chain (Consensus Layer) как отдельной цепочки с PoS
2. **2021-2022:** Beacon Chain работает параллельно с PoW Ethereum (Execution Layer)
3. **15 сентября 2022:** The Merge -- Execution Layer подключается к Beacon Chain

```
До The Merge:
[Execution Layer: PoW] --- работает отдельно
[Beacon Chain: PoS]    --- работает отдельно

После The Merge:
[Execution Layer] + [Consensus Layer (Beacon Chain)] = Ethereum PoS
  транзакции, EVM,      слоты, эпохи, валидаторы,
  состояние              аттестации, финальность
```

После Merge энергопотребление Ethereum снизилось на **99.95%**. Майнеры стали не нужны -- их заменили валидаторы.

## Алгоритм консенсуса: Gasper

Консенсус Ethereum PoS называется **Gasper** и состоит из двух протоколов:

### Casper FFG (Friendly Finality Gadget)

Casper FFG отвечает за **финальность** -- гарантию того, что блок никогда не будет отменен.

```
Механизм финальности:
1. Каждую эпоху (32 слота) создается checkpoint
2. Валидаторы голосуют за checkpoint (source -> target)
3. Если checkpoint получает 2/3 голосов:
   - 1-я эпоха голосования: checkpoint = "justified"
   - 2-я эпоха голосования: justified checkpoint = "finalized"
4. Финализированный блок НЕВОЗМОЖНО отменить без slashing 1/3 валидаторов

Время до финальности: 2 эпохи = 12.8 минут
Сравните: Bitcoin ~60 минут (вероятностная финальность, 6 блоков)
```

### LMD GHOST (Latest Message Driven GHOST)

LMD GHOST -- это правило выбора форка (fork-choice rule). Когда есть несколько конкурирующих цепочек, валидаторы выбирают ту, которая получила больше аттестаций:

```
LMD GHOST выбирает каноническую цепочку по весу аттестаций:

    Block A (5 аттестаций)
   /
Root
   \
    Block B (12 аттестаций) <-- выбирается этот форк

"GHOST" = Greediest Heaviest Observed Sub-Tree
"LMD"   = используются только последние сообщения каждого валидатора
```

Вместе Casper FFG + LMD GHOST = **Gasper**: LMD GHOST выбирает цепочку в реальном времени, Casper FFG финализирует checkpoints каждые 2 эпохи.

## Beacon Chain: слоты и эпохи

<BeaconChainDiagram client:load />

Структура времени в Beacon Chain:

```
1 слот = 12 секунд
1 эпоха = 32 слота = 384 секунды = 6.4 минуты

В каждом слоте:
- 1 proposer предлагает блок (выбран псевдослучайно через RANDAO)
- Комитет из 128+ валидаторов аттестует блок
- Аттестация содержит: head vote (LMD GHOST) + source/target vote (Casper FFG)

За 1 эпоху ВСЕ активные валидаторы аттестуют ровно один раз
```

### RANDAO: выбор proposer

Для каждого слота протокол выбирает proposer. Выбор должен быть непредсказуемым (иначе атакующий подготовит двойной блок):

```python
# Упрощенная логика RANDAO:
randao_mix = initial_seed
for block in blocks:
    # Каждый proposer добавляет свою случайность
    reveal = BLS_sign(private_key, epoch)
    randao_mix = XOR(randao_mix, hash(reveal))

# Proposer для слота:
proposer_index = randao_mix % len(active_validators)
```

RANDAO не идеален -- последний proposer эпохи может "отказаться" от блока, чтобы повлиять на mix. Но экономическая стоимость этого (потеря награды за блок) делает атаку нерентабельной.

## Математический уровень

### Экономическая безопасность

Стоимость атаки на PoS Ethereum:

```
Для нарушения финальности нужно контролировать >= 1/3 стейка
(Casper FFG: финальность = 2/3 голосов, нарушение = > 1/3 противовесов)

Общий стейк сети: ~33 000 000 ETH
1/3 стейка: ~11 000 000 ETH

При цене ETH ~$3000:
Стоимость атаки >= $33 000 000 000 (33 миллиарда долларов)
+ slashing уничтожит весь залог атакующего
```

### Базовая награда валидатора

```
base_reward = effective_balance * BASE_REWARD_FACTOR
              / (sqrt(total_active_balance) * BASE_REWARDS_PER_EPOCH)

BASE_REWARD_FACTOR = 64
BASE_REWARDS_PER_EPOCH = 4

Для 32 ETH при общем стейке 33M ETH:
base_reward = 32e9 * 64 / (sqrt(33e15) * 4) ≈ 8904 gwei / эпоха

Годовой доход ≈ base_reward * 4 * epochs_per_year
             ≈ 8904 * 4 * 82125 ≈ 2.93 ETH/год (~9.14% APR при 33M стейке)
```

Реальная APR зависит от количества стейкеров: чем больше валидаторов, тем ниже индивидуальная награда.

## Pectra: эволюция PoS

Обновление Pectra (май 2025) внесло важные изменения в механику PoS:

| EIP | Изменение | Значение |
|-----|-----------|----------|
| EIP-7251 | Макс. эффективный баланс 32 → 2048 ETH | Консолидация валидаторов: вместо 64 валидаторов можно запустить 1 с 2048 ETH |
| EIP-6110 | Обработка депозитов на Execution Layer | Активация ускорена с ~13 часов до ~13 минут |
| EIP-7002 | Выход через Execution Layer | Смарт-контракты могут управлять выходом валидаторов |
| EIP-7691 | Удвоение blob-пропускной способности | target 3→6, max 6→9 (для L2 rollups) |

Pectra -- это шаг к более эффективной и масштабируемой PoS системе.

## Связь с предыдущими темами

- **SHA-256 / Keccak** (CRYPTO-03/05): хеши используются повсюду: RANDAO, Merkle proofs в Beacon State, подписи аттестаций
- **ECDSA / BLS** (CRYPTO-11): валидаторы используют BLS подписи (BLS12-381) вместо ECDSA -- позволяет агрегировать тысячи подписей в одну
- **PoW** (BTC-06/07): PoS решает проблему энергопотребления PoW, сохраняя экономическую безопасность

## Что дальше?

Мы разобрали, как работает PoS на уровне протокола. В следующем уроке детально изучим **жизненный цикл валидатора**: от депозита 32 ETH через активацию, аттестации и награды до добровольного выхода и механизма slashing.

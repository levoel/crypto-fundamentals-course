/**
 * Vulnerability Overview Diagrams (SEC-01)
 *
 * Exports:
 * - OWASPTaxonomyDiagram: OWASP Smart Contract Top 10 (2025) grid with color-coded DataBox cards
 * - AttackTimelineDiagram: Historical DeFi attacks timeline (The DAO 2016 through Euler 2023)
 */

import { useState } from 'react';
import { DiagramContainer } from '@primitives/DiagramContainer';
import { DataBox } from '@primitives/DataBox';
import { colors, glassStyle } from '@primitives/shared';

/* ================================================================== */
/*  OWASPTaxonomyDiagram                                                */
/* ================================================================== */

interface OWASPCategory {
  rank: number;
  name: string;
  swcIds: string[];
  description: string;
  lessonRef: string;
  coverage: 'current' | 'future' | 'mentioned';
}

const OWASP_TOP_10: OWASPCategory[] = [
  {
    rank: 1,
    name: 'Access Control',
    swcIds: ['SWC-100', 'SWC-106'],
    description: 'Отсутствие или обход ограничений доступа к функциям контракта',
    lessonRef: 'SEC-04',
    coverage: 'current',
  },
  {
    rank: 2,
    name: 'Price Oracle Manipulation',
    swcIds: ['SWC-116'],
    description: 'Манипуляция ценовыми оракулами для извлечения прибыли',
    lessonRef: 'SEC-05',
    coverage: 'future',
  },
  {
    rank: 3,
    name: 'Logic Errors',
    swcIds: ['SWC-110'],
    description: 'Ошибки в бизнес-логике контракта, не покрытые другими категориями',
    lessonRef: 'SEC-06',
    coverage: 'future',
  },
  {
    rank: 4,
    name: 'Lack of Input Validation',
    swcIds: ['SWC-101'],
    description: 'Отсутствие проверки входных данных (параметров функций)',
    lessonRef: 'SEC-06',
    coverage: 'future',
  },
  {
    rank: 5,
    name: 'Reentrancy',
    swcIds: ['SWC-107'],
    description: 'Рекурсивный вызов функции до завершения обновления состояния',
    lessonRef: 'SEC-02',
    coverage: 'current',
  },
  {
    rank: 6,
    name: 'Unchecked External Calls',
    swcIds: ['SWC-104'],
    description: 'Игнорирование возвращаемого значения low-level call',
    lessonRef: 'SEC-07',
    coverage: 'future',
  },
  {
    rank: 7,
    name: 'Flash Loan Attacks',
    swcIds: [],
    description: 'Использование мгновенных займов для манипуляции состоянием протокола',
    lessonRef: 'SEC-05',
    coverage: 'future',
  },
  {
    rank: 8,
    name: 'Integer Overflow / Underflow',
    swcIds: ['SWC-101'],
    description: 'Переполнение арифметических операций (unchecked блоки в 0.8+)',
    lessonRef: 'SEC-03',
    coverage: 'current',
  },
  {
    rank: 9,
    name: 'Denial of Service',
    swcIds: ['SWC-113', 'SWC-128'],
    description: 'Блокировка работы контракта (gas limit, selfdestruct)',
    lessonRef: 'SEC-08',
    coverage: 'future',
  },
  {
    rank: 10,
    name: 'Front-Running / MEV',
    swcIds: ['SWC-114'],
    description: 'Опережающие транзакции и sandwich-атаки через mempool',
    lessonRef: 'SEC-07',
    coverage: 'future',
  },
];

const coverageColors: Record<string, string> = {
  current: colors.success,
  future: colors.info,
  mentioned: colors.textMuted,
};

const coverageLabels: Record<string, string> = {
  current: 'Этот модуль',
  future: 'SEC-05..08',
  mentioned: 'Упоминается',
};

/**
 * OWASPTaxonomyDiagram
 *
 * OWASP Smart Contract Top 10 (2025) as a grid of 10 cards.
 * Color-coded by module coverage: green = SEC-02/03/04, blue = SEC-05..08, gray = mentioned.
 * Hover/click reveals SWC IDs and lesson reference.
 */
export function OWASPTaxonomyDiagram() {
  const [selectedIdx, setSelectedIdx] = useState<number | null>(null);

  const selected = selectedIdx !== null ? OWASP_TOP_10[selectedIdx] : null;

  return (
    <DiagramContainer title="OWASP Smart Contract Top 10 (2025)" color="rose">
      {/* Legend */}
      <div style={{ display: 'flex', gap: 16, marginBottom: 16, flexWrap: 'wrap' }}>
        {Object.entries(coverageLabels).map(([key, label]) => (
          <div key={key} style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
            <div style={{
              width: 10,
              height: 10,
              borderRadius: 3,
              background: coverageColors[key],
              opacity: 0.8,
            }} />
            <span style={{ fontSize: 11, color: colors.textMuted, fontFamily: 'monospace' }}>
              {label}
            </span>
          </div>
        ))}
      </div>

      {/* Grid of 10 cards */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill, minmax(170px, 1fr))',
        gap: 10,
        marginBottom: 16,
      }}>
        {OWASP_TOP_10.map((cat, i) => {
          const isSelected = selectedIdx === i;
          const borderColor = coverageColors[cat.coverage];

          return (
            <div
              key={i}
              onClick={() => setSelectedIdx(isSelected ? null : i)}
              style={{
                ...glassStyle,
                padding: 14,
                cursor: 'pointer',
                background: isSelected ? `${borderColor}15` : 'rgba(255,255,255,0.03)',
                border: `1px solid ${isSelected ? borderColor : 'rgba(255,255,255,0.08)'}`,
                transition: 'all 0.2s',
              }}
            >
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: 6,
              }}>
                <span style={{
                  fontSize: 18,
                  fontWeight: 700,
                  color: borderColor,
                  fontFamily: 'monospace',
                }}>
                  #{cat.rank}
                </span>
                <span style={{
                  fontSize: 9,
                  color: borderColor,
                  fontFamily: 'monospace',
                  background: `${borderColor}15`,
                  padding: '2px 6px',
                  borderRadius: 4,
                  border: `1px solid ${borderColor}30`,
                }}>
                  {coverageLabels[cat.coverage]}
                </span>
              </div>
              <div style={{
                fontSize: 12,
                fontWeight: 600,
                color: isSelected ? borderColor : colors.text,
                fontFamily: 'monospace',
                marginBottom: 4,
              }}>
                {cat.name}
              </div>
              <div style={{ fontSize: 11, color: colors.textMuted, lineHeight: 1.4 }}>
                {cat.description}
              </div>
            </div>
          );
        })}
      </div>

      {/* Detail panel */}
      {selected && (
        <div style={{
          ...glassStyle,
          padding: 16,
          marginBottom: 12,
          border: `1px solid ${coverageColors[selected.coverage]}30`,
        }}>
          <div style={{
            fontSize: 14,
            fontWeight: 600,
            color: coverageColors[selected.coverage],
            fontFamily: 'monospace',
            marginBottom: 8,
          }}>
            #{selected.rank}: {selected.name}
          </div>
          <div style={{ fontSize: 13, color: colors.text, lineHeight: 1.6, marginBottom: 10 }}>
            {selected.description}
          </div>
          <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>
            <div style={{ fontSize: 11, fontFamily: 'monospace' }}>
              <span style={{ color: colors.textMuted }}>SWC: </span>
              <span style={{ color: colors.accent }}>
                {selected.swcIds.length > 0 ? selected.swcIds.join(', ') : 'N/A'}
              </span>
            </div>
            <div style={{ fontSize: 11, fontFamily: 'monospace' }}>
              <span style={{ color: colors.textMuted }}>Урок: </span>
              <span style={{ color: coverageColors[selected.coverage] }}>{selected.lessonRef}</span>
            </div>
          </div>
        </div>
      )}

      <DataBox
        label="OWASP Smart Contract Top 10"
        value="Классификация 10 наиболее критичных уязвимостей смарт-контрактов. Access Control (#1) и Reentrancy (#5) -- самые дорогостоящие по историческим потерям."
        variant="highlight"
      />
    </DiagramContainer>
  );
}

/* ================================================================== */
/*  AttackTimelineDiagram                                                */
/* ================================================================== */

interface HistoricalAttack {
  year: number;
  month: string;
  name: string;
  loss: string;
  lossNum: number;
  vulnerability: string;
  vulnType: 'reentrancy' | 'access_control' | 'oracle' | 'flash_loan' | 'logic' | 'overflow';
  description: string;
}

const ATTACK_HISTORY: HistoricalAttack[] = [
  {
    year: 2016,
    month: 'Июнь',
    name: 'The DAO',
    loss: '$60M',
    lossNum: 60,
    vulnerability: 'Reentrancy',
    vulnType: 'reentrancy',
    description: 'Рекурсивный вызов withdraw() до обновления баланса. Привел к хардфорку Ethereum и появлению Ethereum Classic.',
  },
  {
    year: 2018,
    month: 'Апрель',
    name: 'BEC Token (BatchOverflow)',
    loss: '$900M (рыночная)',
    lossNum: 900,
    vulnerability: 'Integer Overflow',
    vulnType: 'overflow',
    description: 'Переполнение uint256 в batchTransfer(): amount * cnt оборачивалось в 0, а cnt получателей получали amount токенов.',
  },
  {
    year: 2020,
    month: 'Февраль',
    name: 'bZx Flash Loan',
    loss: '$8M',
    lossNum: 8,
    vulnerability: 'Flash Loan + Oracle',
    vulnType: 'flash_loan',
    description: 'Flash loan для манипуляции цены на Uniswap V1 (spot price как оракул), затем выгодный обмен на bZx.',
  },
  {
    year: 2021,
    month: 'Август',
    name: 'Poly Network',
    loss: '$611M',
    lossNum: 611,
    vulnerability: 'Access Control',
    vulnType: 'access_control',
    description: 'Обход проверки подписи в cross-chain bridge. Атакующий смог менять keeper-ов и выводить любые средства.',
  },
  {
    year: 2022,
    month: 'Февраль',
    name: 'Wormhole Bridge',
    loss: '$326M',
    lossNum: 326,
    vulnerability: 'Input Validation',
    vulnType: 'logic',
    description: 'Подделка VAA (Verified Action Approval) через использование устаревшей функции verify_signatures() из неинициализированного guardian set.',
  },
  {
    year: 2022,
    month: 'Октябрь',
    name: 'Mango Markets',
    loss: '$114M',
    lossNum: 114,
    vulnerability: 'Oracle Manipulation',
    vulnType: 'oracle',
    description: 'Манипуляция ценой MNGO на Mango Markets через позицию perp для завышения collateral value и заимствования всех активов.',
  },
  {
    year: 2023,
    month: 'Март',
    name: 'Euler Finance',
    loss: '$197M',
    lossNum: 197,
    vulnerability: 'Logic Error + Donation',
    vulnType: 'logic',
    description: 'Donation attack: жертвование eTokens контракту для занижения резервов. Ошибка в логике health check позволяла ликвидировать собственную позицию.',
  },
];

const vulnTypeColors: Record<string, string> = {
  reentrancy: '#f43f5e',
  access_control: '#a78bfa',
  oracle: '#f59e0b',
  flash_loan: colors.accent,
  logic: colors.info,
  overflow: '#fb923c',
};

const vulnTypeLabels: Record<string, string> = {
  reentrancy: 'Reentrancy',
  access_control: 'Access Control',
  oracle: 'Oracle',
  flash_loan: 'Flash Loan',
  logic: 'Logic Error',
  overflow: 'Overflow',
};

/**
 * AttackTimelineDiagram
 *
 * Historical DeFi attacks timeline: 7 major attacks from 2016 to 2023.
 * Color-coded tags by vulnerability type. Click to expand details.
 */
export function AttackTimelineDiagram() {
  const [selectedIdx, setSelectedIdx] = useState<number | null>(null);

  const selected = selectedIdx !== null ? ATTACK_HISTORY[selectedIdx] : null;

  // SVG bar chart of losses
  const svgW = 480;
  const svgH = 140;
  const padL = 48;
  const padR = 10;
  const padT = 10;
  const padB = 30;
  const chartW = svgW - padL - padR;
  const chartH = svgH - padT - padB;

  const maxLoss = Math.max(...ATTACK_HISTORY.map((a) => a.lossNum));
  const barW = chartW / ATTACK_HISTORY.length - 6;

  return (
    <DiagramContainer title="Хронология крупнейших DeFi-атак (2016--2023)" color="rose">
      {/* Legend */}
      <div style={{ display: 'flex', gap: 12, marginBottom: 12, flexWrap: 'wrap' }}>
        {Object.entries(vulnTypeLabels).map(([key, label]) => (
          <div key={key} style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{
              width: 8,
              height: 8,
              borderRadius: 2,
              background: vulnTypeColors[key],
            }} />
            <span style={{ fontSize: 10, color: colors.textMuted, fontFamily: 'monospace' }}>
              {label}
            </span>
          </div>
        ))}
      </div>

      {/* SVG loss chart */}
      <div style={{ display: 'flex', justifyContent: 'center', marginBottom: 16 }}>
        <svg width={svgW} height={svgH} style={{ overflow: 'visible' }}>
          {/* Y axis */}
          <line x1={padL} y1={padT} x2={padL} y2={padT + chartH} stroke="rgba(255,255,255,0.15)" />
          {/* X axis */}
          <line x1={padL} y1={padT + chartH} x2={padL + chartW} y2={padT + chartH} stroke="rgba(255,255,255,0.15)" />

          {/* Y labels */}
          {[0, 250, 500, 750].filter((v) => v <= maxLoss + 100).map((v) => (
            <text key={v} x={padL - 4} y={padT + chartH - (v / (maxLoss * 1.15)) * chartH + 3} fill={colors.textMuted} fontSize={8} textAnchor="end" fontFamily="monospace">
              ${v}M
            </text>
          ))}

          {/* Bars */}
          {ATTACK_HISTORY.map((atk, i) => {
            const x = padL + i * (chartW / ATTACK_HISTORY.length) + 3;
            const barH = (atk.lossNum / (maxLoss * 1.15)) * chartH;
            const y = padT + chartH - barH;
            const isSelected = selectedIdx === i;
            const barColor = vulnTypeColors[atk.vulnType];

            return (
              <g key={i} onClick={() => setSelectedIdx(isSelected ? null : i)} style={{ cursor: 'pointer' }}>
                <rect
                  x={x}
                  y={y}
                  width={barW}
                  height={barH}
                  fill={barColor}
                  opacity={isSelected ? 1 : 0.6}
                  rx={3}
                />
                {/* Loss label */}
                <text
                  x={x + barW / 2}
                  y={y - 4}
                  fill={barColor}
                  fontSize={8}
                  textAnchor="middle"
                  fontFamily="monospace"
                  fontWeight={isSelected ? 700 : 400}
                >
                  {atk.loss}
                </text>
                {/* Year label */}
                <text
                  x={x + barW / 2}
                  y={padT + chartH + 12}
                  fill={isSelected ? colors.text : colors.textMuted}
                  fontSize={9}
                  textAnchor="middle"
                  fontFamily="monospace"
                >
                  {atk.year}
                </text>
                {/* Name label */}
                <text
                  x={x + barW / 2}
                  y={padT + chartH + 24}
                  fill={isSelected ? barColor : colors.textMuted}
                  fontSize={7}
                  textAnchor="middle"
                  fontFamily="monospace"
                >
                  {atk.name.length > 12 ? atk.name.slice(0, 11) + '..' : atk.name}
                </text>
              </g>
            );
          })}
        </svg>
      </div>

      {/* Detail panel */}
      {selected && (
        <div style={{
          ...glassStyle,
          padding: 16,
          marginBottom: 12,
          border: `1px solid ${vulnTypeColors[selected.vulnType]}30`,
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
            <div style={{
              fontSize: 14,
              fontWeight: 600,
              color: vulnTypeColors[selected.vulnType],
              fontFamily: 'monospace',
            }}>
              {selected.name} ({selected.month} {selected.year})
            </div>
            <span style={{
              fontSize: 10,
              fontFamily: 'monospace',
              background: `${vulnTypeColors[selected.vulnType]}15`,
              color: vulnTypeColors[selected.vulnType],
              padding: '2px 8px',
              borderRadius: 4,
              border: `1px solid ${vulnTypeColors[selected.vulnType]}30`,
            }}>
              {selected.vulnerability}
            </span>
          </div>
          <div style={{ fontSize: 12, color: colors.text, lineHeight: 1.6, marginBottom: 8 }}>
            {selected.description}
          </div>
          <div style={{ fontSize: 11, fontFamily: 'monospace', color: colors.textMuted }}>
            Потери: <span style={{ color: '#f43f5e', fontWeight: 600 }}>{selected.loss}</span>
          </div>
        </div>
      )}

      <DataBox
        label="Ключевой вывод"
        value="Потери от уязвимостей смарт-контрактов превышают $2B. The DAO (2016) привел к хардфорку Ethereum. Каждая атака привела к созданию новых инструментов и стандартов безопасности."
        variant="highlight"
      />
    </DiagramContainer>
  );
}

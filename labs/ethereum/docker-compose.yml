# Ethereum Development Lab - Anvil (Foundry)
# Provides local EVM node for smart contract development
# Anvil includes 10 pre-funded accounts with 10000 ETH each

services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:${FOUNDRY_VERSION:-latest}
    container_name: ethereum-anvil
    entrypoint: ["anvil", "--host", "0.0.0.0"]
    ports:
      - "${ANVIL_PORT:-8545}:8545"
    healthcheck:
      test: ["CMD-SHELL", "cast chain-id --rpc-url http://localhost:8545 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  # Mainnet fork for DeFi testing (LAB-05)
  anvil-fork:
    image: ghcr.io/foundry-rs/foundry:${FOUNDRY_VERSION:-latest}
    container_name: ethereum-anvil-fork
    entrypoint:
      - "anvil"
      - "--host"
      - "0.0.0.0"
      - "--fork-url"
      - "${MAINNET_RPC_URL}"
      - "--fork-block-number"
      - "${FORK_BLOCK_NUMBER:-21400000}"
    ports:
      - "${FORK_PORT:-8546}:8545"
    profiles: ["fork"]
    healthcheck:
      test: ["CMD-SHELL", "cast chain-id --rpc-url http://localhost:8545 || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s

  # Security analysis tools (LAB-06)
  # WARNING: Security tool images are large (2-3 GB each)
  # First run will download images. Ensure sufficient disk space.
  slither:
    image: trailofbits/eth-security-toolbox
    container_name: ethereum-slither
    working_dir: /share
    volumes:
      - .:/share
    entrypoint: ["slither"]
    profiles: ["security"]
    # Usage: docker compose --profile security run slither contracts/security/VulnerableVault.sol --solc-remaps '@openzeppelin/=node_modules/@openzeppelin/'

  mythril:
    image: mythril/myth
    container_name: ethereum-mythril
    volumes:
      - .:/tmp
    entrypoint: ["myth"]
    profiles: ["security"]
    # Usage: docker compose --profile security run mythril analyze /tmp/contracts/security/VulnerableVault.sol --solv 0.8.28
